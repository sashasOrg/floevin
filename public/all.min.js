angular.module("SashasApp",["ui.router","ngCookies"]),angular.module("SashasApp").config(["$stateProvider","$urlRouterProvider",function(t,r){t.state("home",{url:"/",templateUrl:"/home.html",controller:"mainController",access:{restricted:!1}}).state("form",{url:"/form",templateUrl:"/form.html",controller:"formController",access:{restricted:!1}}).state("login",{url:"/login",templateUrl:"/login.html",controller:"loginController",access:{restricted:!1}}).state("register",{url:"/register",templateUrl:"/register.html",controller:"registerController",access:{restricted:!1}}).state("portfolio",{url:"/portfolio",templateUrl:"/portfolio.html",controller:"userController",access:{restricted:!1}}).state("stock",{url:"/stock",templateUrl:"/stock.html",controller:"mainController",access:{restricted:!1}}).state("fundinfo",{url:"/fundinfo",templateUrl:"/fundinfo.html",controller:"formController",access:{restricted:!1}}).state("admin",{url:"/admin",templateUrl:"/admin.html",controller:"formController",access:{restricted:!1}}),r.otherwise("/")}]),angular.module("SashasApp").run(["$state","$rootScope","$location","AuthService",function(t,r,e,o){r.$on("$stateChangeStart",function(r,e,l){o.getUserStatus(),e.access.restricted&&!o.isLoggedIn()&&(r.preventDefault(),t.go("login"))})}]);
angular.module("SashasApp").factory("AuthService",["$q","$timeout","$http","$state","$cookies",function(e,r,s,t,u){function n(){return null===JSON.stringify(u.get("currentUser"))?user=null:user=!0,!!user}function o(){s.get("/user/status").success(function(e){e.status?user=!0:user=!1}).error(function(e){user=!1})}function c(r,t){var n=e.defer();return s.post("/user/login",{username:r,password:t}).success(function(e,r){200===r&&e.status?(user=!0,console.log(u.get("currentUser")),n.resolve(e.user)):(user=!1,n.reject())}).error(function(e){user=!1,n.reject()}),n.promise}function i(){var r=e.defer();return s.get("/user/logout").success(function(e){user=!1,u.remove("currentUser"),r.resolve()}).error(function(e){user=!1,r.reject()}),r.promise}function a(r,t,u,n,o){var c=e.defer();return s.post("/user/register",{username:r,password:t,firstName:u,lastName:n,email:o}).success(function(e,r){200===r&&e.status?c.resolve():c.reject()}).error(function(e){c.reject()}),c.promise}return this.currentUser=u.get("currentUser"),{isLoggedIn:n,getUserStatus:o,login:c,logout:i,register:a}}]);
angular.module("SashasApp").service("formService",["$http","$q","$cookies",function(n,t,u){this.getFund=function(){return n.get("/fund")},this.newFund=function(t){console.log(t),n.post("/fund",t)},this.fundQuery=function(t){return n.get("/fund/specific?id="+t)},this.updateFund=function(t){return n.put("/fund"+t,update)},this.deleteFund=function(t){n({method:"DELETE",url:"/fund?id="+t}).then(function(n){return n},function(n){return n})}}]);
angular.module("SashasApp").service("mainService",["$http","$q","$cookies",function(e,t,o){this.data=[],this.searchSymbols=function(t){return e.jsonp("http://d.yimg.com/aq/autoc?query="+t+"&region=US&lang=en-US&callback=JSON_CALLBACK")},this.getMoreInformation=function(t){return e.get("http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.quotes%20where%20symbol%20IN%20(%22"+t+"%22,%22"+t+"%22)&format=json&env=http://datatables.org/alltables.env")},this.updateUser=function(t){return e.put("user?id="+JSON.parse(o.get("currentUser"))._id,t)},this.getUserPortfolio=function(t){return e.get("user/portfolio?username="+t)}}]);
angular.module("SashasApp").service("userService",["$http",function(e){}]);
function bubbleChart(){function t(t){return-Math.pow(t.radius,2)/8}function n(t){var n=t.map(function(t){return{id:t.id,radius:C(+t.total_amount),value:t.total_amount,name:t.grant_title,org:t.organization,group:t.group,year:t.start_year,x:900*Math.random(),y:800*Math.random()}});return n.sort(function(t,n){return n.value-t.value}),n}function a(){u(),x.on("tick",function(t){b.each(e(t.alpha)).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}),x.start()}function e(t){return function(n){n.x=n.x+(p.x-n.x)*h*t,n.y=n.y+(p.y-n.y)*h*t}}function r(){s(),x.on("tick",function(t){b.each(o(t.alpha)).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}),x.start()}function o(t){return function(n){var a=y[n.year];n.x=n.x+(a.x-n.x)*h*t*1.1,n.y=n.y+(a.y-n.y)*h*t*1.1}}function u(){m.selectAll(".year").remove()}function s(){var t=d3.keys(v),n=m.selectAll(".year").data(t);n.enter().append("text").attr("class","year").attr("x",function(t){return v[t]}).attr("y",40).attr("text-anchor","middle").text(function(t){return t})}function i(t){d3.select(this).attr("stroke","black");var n='<span class="name">Title: </span><span class="value">'+t.name+'</span><br/><span class="name">Amount: </span><span class="value">$'+addCommas(t.value)+'</span><br/><span class="name">Year: </span><span class="value">'+t.year+"</span>";f.showTooltip(n,d3.event)}function c(t){d3.select(this).attr("stroke",d3.rgb(k(t.group)).darker()),f.hideTooltip()}var l=940,d=600,f=floatingTooltip("gates_tooltip",240),p={x:l/2,y:d/2},y={2008:{x:l/3,y:d/2},2009:{x:l/2,y:d/2},2010:{x:2*l/3,y:d/2}},v={2008:160,2009:l/2,2010:l-160},h=.102,m=null,b=null,g=[],x=d3.layout.force().size([l,d]).charge(t).gravity(-.01).friction(.9),k=d3.scale.ordinal().domain(["low","medium","high"]).range(["#d84b2a","#beccae","#7aa25c"]),C=d3.scale.pow().exponent(.5).range([2,85]);this.getVideos=function(){return $http.get("api/videos").then(function(t){return t.data})},d3.json("/fund",function(t,n){return t?res.status(500).send(t):void res.send(n)});var _=function(t,e){var r=d3.max(e,function(t){return+t.total_amount});C.domain([0,r]),g=n(e),x.nodes(g),m=d3.select(t).append("svg").attr("width",l).attr("height",d),b=m.selectAll(".bubble").data(g,function(t){return t.id}),b.enter().append("circle").classed("bubble",!0).attr("r",0).attr("fill",function(t){return k(t.group)}).attr("stroke",function(t){return d3.rgb(k(t.group)).darker()}).attr("stroke-width",2).on("mouseover",i).on("mouseout",c),b.transition().duration(2e3).attr("r",function(t){return t.radius}),a()};return _.toggleDisplay=function(t){"year"===t?r():a()},_}function display(t,n){t&&console.log(t),myBubbleChart("#vis",n)}function setupButtons(){d3.select("#toolbar").selectAll(".button").on("click",function(){d3.selectAll(".button").classed("active",!1);var t=d3.select(this);t.classed("active",!0);var n=t.attr("id");myBubbleChart.toggleDisplay(n)})}function addCommas(t){t+="";for(var n=t.split("."),a=n[0],e=n.length>1?"."+n[1]:"",r=/(\d+)(\d{3})/;r.test(a);)a=a.replace(r,"$1,$2");return a+e}var myBubbleChart=bubbleChart();d3.csv("data/gates_money.csv",display),setupButtons();
function floatingTooltip(t,i){function o(t,i){l.style("opacity",1).html(t),n(i)}function e(){l.style("opacity",0)}function n(t){var i=20,o=10,e=l.style("width"),n=l.style("height"),d=window.scrollY,a=window.scrollX,p=document.all?t.clientX+a:t.pageX,s=document.all?t.clientY+d:t.pageY,c=p-a+2*i+e>window.innerWidth?p-e-2*i:p+i;a+i>c&&(c=a+i);var r=s-d+2*o+n>window.innerHeight?s-n-2*o:s+o;d+o>r&&(r=s+o),l.style({top:r+"px",left:c+"px"})}var l=d3.select("body").append("div").attr("class","tooltip").attr("id",t).style("pointer-events","none");return i&&l.style("width",i),e(),{showTooltip:o,hideTooltip:e,updatePosition:n}}
angular.module("SashasApp").controller("loginController",["$state","$scope","$location","$cookies","AuthService","mainService",function(e,r,o,n,t,i){r.isLoggedIn=t.isLoggedIn,r.login=function(){r.error=!1,r.disabled=!0,t.login(r.loginForm.username,r.loginForm.password).then(function(o){r.disabled=!1,r.loginForm={},t.isLoggedIn(),n.remove("currentUser"),n.put("currentUser",JSON.stringify(o)),i.getUserPortfolio(JSON.parse(n.get("currentUser")).username).then(function(r){console.log("response two",r),n.remove("currentUserPortfolio"),n.put("currentUserPortfolio",JSON.stringify(r.data)),e.go("portfolio")})})["catch"](function(){r.error=!0,r.errorMessage="Invalid username and/or password",r.disabled=!1,r.loginForm={}})}}]),angular.module("SashasApp").controller("logoutController",["$scope","$location","$cookies","AuthService","mainService",function(e,r,o,n,t){e.userLogged=n.isLoggedIn(),e.$watch(e.userLogged),e.logout=function(){n.logout().then(function(){o.remove("currentUser"),o.remove("currentUserPortfolio"),r.path("login")}),console.log("logout")}}]),angular.module("SashasApp").controller("registerController",["$scope","$location","AuthService",function(e,r,o){e.register=function(){e.error=!1,e.disabled=!0,o.register(e.registerForm.username,e.registerForm.password,e.registerForm.firstName,e.registerForm.lastName,e.registerForm.email).then(function(){r.path("login"),e.disabled=!1,e.registerForm={}})["catch"](function(){e.error=!0,e.errorMessage="Something went wrong!",e.disabled=!1,e.registerForm={}})}}]);
angular.module("SashasApp").controller("formController",["$scope","$cookies","formService",function(n,e,o){n.seachFund="",n.anyfund=function(){console.log("test"),n.error=!1,n.disabled=!0,o.newFund(n.newfundForm)},n.fundQuery=function(){o.fundQuery(n.searchFund).then(function(e){n.fund=e})},n.getFund=function(){o.getFund().then(function(e){n.fundinfo=e.data})},n.getFund(),n.newFund=function(e,u,t,i,d,r,c,f){o.newFund(e,u,t,i,d,r,c,f).then(function(e){n.getFund()})},n.toggle=function(){n.showing=!n.showing},n.showing=!1}]),angular.module("SashasApp").directive("hideForm",function(){function n(n,e,o){var u=o.hideForm;n.$eval(u)||e.hide(),n.$watch(u,function(n,o){n!==o&&(n?e.stop(!0,!0).slideDown():e.stop(!0,!0).slideUp())})}return{link:n,restrict:"A"}});
angular.module("SashasApp").controller("mainController",["$scope","$state","$cookies","mainService",function(r,e,o,t){r.data=t.data,r.specificData=t.specificData,r.stockQuery="",r.mainService={},r.searchSymbols=function(){t.searchSymbols(r.stockQuery).then(function(r){t.data=r.data.ResultSet.Result,e.reload()})},r.getMoreInformation=function(r){t.getMoreInformation(r).then(function(r){t.specificData=r.data.query.results.quote,console.log(t.specificData),e.reload()})},r.addToPortfolio=function(r){var n=JSON.parse(o.get("currentUser"));console.log(n.portfolio);for(var s=0;s<n.portfolio.length;s++)if(r===JSON.parse(o.get("currentUser")).portfolio[s])return console.log("Already exists in portfolio"),!1;n.portfolio.push(r),o.remove("currentUser"),o.put("currentUser",JSON.stringify(n)),t.updateUser(n),t.getUserPortfolio(n.username).then(function(r){o.remove("currentUserPortfolio"),o.put("currentUserPortfolio",JSON.stringify(r.data))}),e.reload(),n=null},r.checkPortfolio=function(r){t.getUserPortfolio(JSON.parse(o.get("currentUser")).username).then(function(r){o.remove("currentUserPortfolio"),o.put("currentUserPortfolio",JSON.stringify(r.data))});for(var e=0;e<JSON.parse(o.get("currentUserPortfolio")).portfolio.length;e++)if(r===JSON.parse(o.get("currentUserPortfolio")).portfolio[e]._id)return!1;return!0},r.removeFromPortfolio=function(r){t.getUserPortfolio(JSON.parse(o.get("currentUser")).username).then(function(r){o.remove("currentUserPortfolio"),o.put("currentUserPortfolio",JSON.stringify(r.data))});for(var e=0;e<JSON.parse(o.get("currentUser")).portfolio.length;e++)if(console.log(JSON.parse(o.get("currentUser")).portfolio[e]),console.log(r),r===JSON.parse(o.get("currentUser")).portfolio[e]){var n=JSON.parse(o.get("currentUser"));console.log("this is user before",n),n.portfolio.splice(e,1),console.log("this is user after",n),t.updateUser(n).then(function(r){o.remove("currentUser"),o.put("currentUser",JSON.stringify(r.data)),console.log("response here",r.data)})}else console.log("Wasnt Found")}}]);
angular.module("SashasApp").controller("userController",["$scope","$state","$cookies","mainService",function(r,e,o,t){r.currentUserCookie=JSON.parse(o.get("currentUser")),r.$watch(r.currentUserCookie),r.currentUserPortfolioCookie=JSON.parse(o.get("currentUserPortfolio")),r.$watch(r.currentUserPortfolioCookie),r.checkPortfolio=function(r){for(var e=0;e<JSON.parse(o.get("currentUserPortfolio")).portfolio.length;e++)return r===JSON.parse(o.get("currentUserPortfolio")).portfolio[e]._id},r.removeFromPortfolio=function(r){if(console.log("length of thing",JSON.parse(o.get("currentUser")).portfolio.length),1===JSON.parse(o.get("currentUser")).portfolio.length){var s=JSON.parse(o.get("currentUser"));s.portfolio=[],o.remove("currentUser"),o.put("currentUser",JSON.stringify(s)),t.updateUser(s),console.log("hope this works"),t.getUserPortfolio(JSON.parse(o.get("currentUser")).username).then(function(r){o.remove("currentUserPortfolio"),o.put("currentUserPortfolio",JSON.stringify(r.data)),e.reload()})}t.getUserPortfolio(JSON.parse(o.get("currentUser")).username).then(function(r){o.remove("currentUserPortfolio"),o.put("currentUserPortfolio",JSON.stringify(r.data))});for(var n=0;n<JSON.parse(o.get("currentUser")).portfolio.length;n++)if(console.log(JSON.parse(o.get("currentUser")).portfolio[n]),console.log(r),r===JSON.parse(o.get("currentUser")).portfolio[n]){var l=JSON.parse(o.get("currentUser"));l.portfolio.splice(n,1),o.remove("currentUser"),o.put("currentUser",JSON.stringify(l)),t.updateUser(l),t.getUserPortfolio(JSON.parse(o.get("currentUser")).username).then(function(r){console.log("portfolio response here",r),o.remove("currentUserPortfolio"),o.put("currentUserPortfolio",JSON.stringify(r.data)),e.reload()})}else console.log("Wasnt Found")},r.checkUserCookie=function(){console.log("yes",JSON.parse(o.get("currentUser"))),console.log("hello",JSON.parse(o.get("currentUserPortfolio")))}}]);